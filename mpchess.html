<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Chess</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Libraries for Chess Logic and Firebase -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            background-color: #1f2937; /* bg-gray-800 */
            color: #f9fafb; /* text-gray-50 */
        }
        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 95vw;
            aspect-ratio: 1 / 1;
            max-width: 600px;
            border: 4px solid #4b5563;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .square {
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }
        .light { background-color: #F3F4F6; }
        .dark { background-color: #60A5FA; }
        .piece {
            cursor: grab;
            font-size: var(--piece-font-size, 38px);
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .piece-w { color: white; }
        .piece-b { color: #111827; }
        .selected { background-color: #FBBF24 !important; }
        .valid-move::after {
            content: '';
            position: absolute;
            width: 40%;
            height: 40%;
            border-radius: 50%;
            background-color: rgba(22, 163, 74, 0.5);
            cursor: pointer;
        }
        .in-check { box-shadow: inset 0 0 0 4px #ef4444; }
        .btn { @apply px-6 py-3 font-semibold rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-opacity-75; }
        .btn-primary { @apply btn bg-sky-500 text-white hover:bg-sky-600 focus:ring-sky-400; }
        .btn-green { @apply btn bg-green-600 text-white hover:bg-green-700 focus:ring-green-500; }
        .btn-blue { @apply btn bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500; }
        .btn-red { @apply btn bg-red-600 text-white hover:bg-red-700 focus:ring-red-500; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div id="main-container" class="w-full max-w-5xl mx-auto flex flex-col items-center">
        
        <!-- Loading View -->
        <div id="loading-view" class="text-center p-8">
            <h1 class="text-3xl md:text-5xl font-bold text-center mb-4">Multiplayer Chess</h1>
            <p class="text-xl text-gray-400">Checking Login Status...</p>
        </div>

        <!-- Auth View -->
        <div id="auth-view" class="text-center p-8 hidden">
            <h1 class="text-3xl md:text-5xl font-bold text-center mb-4">Welcome!</h1>
            <p class="text-xl text-gray-400 mb-6">Please log in on the main page to play.</p>
            <a href="index.html?login=true" class="btn-primary text-lg">Go to Login</a>
        </div>

        <!-- Lobby View -->
        <div id="lobby-view" class="w-full max-w-md p-8 bg-gray-900 rounded-lg shadow-xl hidden">
            <h1 class="text-3xl md:text-5xl font-bold text-center mb-6">Game Lobby</h1>
            <div class="space-y-4">
                <button id="create-game-btn" class="w-full btn-green text-lg">Create New Game</button>
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-600"></div>
                    <span class="flex-shrink mx-4 text-gray-400">OR</span>
                    <div class="flex-grow border-t border-gray-600"></div>
                </div>
                <input type="text" id="game-id-input" placeholder="Enter Game ID to Join" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-sky-500 focus:outline-none">
                <button id="join-game-btn" class="w-full btn-blue text-lg">Join Game</button>
            </div>
        </div>

        <!-- Game View -->
        <div id="game-view" class="w-full hidden lg:grid lg:grid-cols-3 lg:gap-8 items-start">
            <div class="lg:col-span-2 flex flex-col items-center">
                <div id="board" class="board"></div>
            </div>
            <div class="w-full mt-4 lg:mt-0 bg-gray-900 p-4 rounded-lg shadow-xl">
                <div id="status-container" class="text-center mb-4 p-3 rounded-lg bg-gray-800 shadow-inner">
                    <p id="status" class="text-lg md:text-xl font-semibold text-gray-200">Loading game...</p>
                </div>
                <div id="player-info" class="space-y-3 mb-4">
                    <div id="player-white-box" class="p-3 bg-gray-700 rounded-lg">
                        <p class="font-bold">White: <span id="player-white-name"></span></p>
                    </div>
                    <div id="player-black-box" class="p-3 bg-gray-700 rounded-lg">
                        <p class="font-bold">Black: <span id="player-black-name"></span></p>
                    </div>
                </div>
                <div id="chat-box" class="mb-4">
                    <div id="chat-messages" class="h-40 bg-gray-800 rounded-lg p-2 overflow-y-auto border border-gray-600"></div>
                    <div class="flex mt-2">
                        <input type="text" id="chat-input" placeholder="Type a message..." class="flex-grow p-2 bg-gray-700 border border-gray-600 rounded-l-lg text-white focus:ring-2 focus:ring-sky-500 focus:outline-none">
                        <button id="send-chat-btn" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-r-lg hover:bg-sky-600">Send</button>
                    </div>
                </div>
                <div>
                    <p class="text-sm text-gray-400 text-center mb-2">Game ID: <span id="game-id-display" class="font-mono cursor-pointer" title="Click to copy"></span></p>
                    <button id="leave-game-btn" class="w-full btn-red">Leave Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center border border-gray-600">
            <p id="message-text" class="text-lg mb-4"></p>
            <button id="close-modal-btn" class="btn-primary">Close</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyD02ui4dhTuGLz-Ff1af36ERdqqsn4iIeU",
                authDomain: "falconixgaming-46210.firebaseapp.com",
                projectId: "falconixgaming-46210",
                storageBucket: "falconixgaming-46210.appspot.com",
                messagingSenderId: "1096905282147",
                appId: "1:1096905282147:web:e2faa9105d31c6ec009e56",
                measurementId: "G-VJ6YC0GXK5"
            };
            
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // DOM Elements
            const loadingView = document.getElementById('loading-view'), authView = document.getElementById('auth-view'), lobbyView = document.getElementById('lobby-view'), gameView = document.getElementById('game-view');
            const createGameBtn = document.getElementById('create-game-btn'), joinGameBtn = document.getElementById('join-game-btn'), leaveGameBtn = document.getElementById('leave-game-btn');
            const gameIdInput = document.getElementById('game-id-input'), gameIdDisplay = document.getElementById('game-id-display');
            const statusElement = document.getElementById('status'), boardElement = document.getElementById('board');
            const playerWhiteName = document.getElementById('player-white-name'), playerBlackName = document.getElementById('player-black-name');
            const playerWhiteBox = document.getElementById('player-white-box'), playerBlackBox = document.getElementById('player-black-box');
            const chatMessages = document.getElementById('chat-messages'), chatInput = document.getElementById('chat-input'), sendChatBtn = document.getElementById('send-chat-btn');
            const messageModal = document.getElementById('message-modal'), messageText = document.getElementById('message-text'), closeModalBtn = document.getElementById('close-modal-btn');

            // Game State
            let currentUser = null, currentGameId = null, playerColor = null;
            let unsubscribeGame = null, unsubscribeChat = null;
            let chess = new Chess();
            let selectedSquare = null;

            // --- AUTHENTICATION ---
            auth.onAuthStateChanged(user => {
                currentUser = user;
                loadingView.classList.add('hidden'); 
                if (user) {
                    authView.classList.add('hidden');
                    if (gameView.classList.contains('hidden')) {
                        lobbyView.classList.remove('hidden');
                    }
                } else {
                    lobbyView.classList.add('hidden');
                    authView.classList.remove('hidden');
                    if (!gameView.classList.contains('hidden')) {
                        leaveGameBtn.click();
                    }
                }
            });

            // --- LOBBY LOGIC ---
            createGameBtn.onclick = async () => {
                const gameId = crypto.randomUUID().split('-')[0];
                const gameRef = db.collection("mp-chess-games").doc(gameId);
                await gameRef.set({
                    fen: new Chess().fen(),
                    players: { [currentUser.uid]: { color: 'w', name: currentUser.displayName } },
                    playerIds: [currentUser.uid],
                    status: 'waiting',
                    winner: null
                });
                switchToGameView(gameId, 'w');
            };

            joinGameBtn.onclick = async () => {
                const gameId = gameIdInput.value.trim();
                if (!gameId) return showMessage("Please enter a Game ID.");
                const gameRef = db.collection("mp-chess-games").doc(gameId);
                const gameSnap = await gameRef.get();

                if (gameSnap.exists) {
                    const gameData = gameSnap.data();
                    if (gameData.playerIds.length === 1 && !gameData.playerIds.includes(currentUser.uid)) {
                        await gameRef.update({
                            [`players.${currentUser.uid}`]: { color: 'b', name: currentUser.displayName },
                            playerIds: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
                            status: 'active'
                        });
                        switchToGameView(gameId, 'b');
                    } else if (gameData.playerIds.includes(currentUser.uid)) {
                        switchToGameView(gameId, gameData.players[currentUser.uid].color);
                    } else {
                        showMessage("This game is full.");
                    }
                } else {
                    showMessage("Game not found.");
                }
            };
            
            leaveGameBtn.onclick = async () => {
                if (currentGameId) {
                    await db.collection("mp-chess-games").doc(currentGameId).update({ status: 'abandoned' }).catch(()=>{});
                }
                if (unsubscribeGame) unsubscribeGame();
                if (unsubscribeChat) unsubscribeChat();
                switchToLobbyView();
            };

            // --- VIEW SWITCHING ---
            function switchToGameView(gameId, color) {
                currentGameId = gameId; 
                playerColor = color;
                gameIdDisplay.textContent = gameId;
                lobbyView.classList.add('hidden');
                gameView.classList.remove('hidden');
                gameView.classList.add('lg:grid');

                unsubscribeGame = db.collection("mp-chess-games").doc(gameId).onSnapshot((doc) => {
                    const gameData = doc.data();
                    if (gameData) {
                        renderGameState(gameData);
                    } else {
                        showMessage("Game session has ended.");
                        leaveGameBtn.click();
                    }
                });

                unsubscribeChat = db.collection("mp-chess-games").doc(gameId).collection("messages").orderBy("timestamp").onSnapshot((snapshot) => {
                    chatMessages.innerHTML = '';
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const sender = msg.senderName ? msg.senderName.split(' ')[0] : 'User';
                        chatMessages.innerHTML += `<div class="p-1"><strong>${sender}:</strong> ${msg.text}</div>`;
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }

            function switchToLobbyView() {
                gameView.classList.add('hidden');
                gameView.classList.remove('lg:grid');
                if(currentUser) lobbyView.classList.remove('hidden');
                else authView.classList.remove('hidden');
                currentGameId = null; playerColor = null; selectedSquare = null; chess = new Chess();
            }

            // --- GAME LOGIC & RENDERING ---
            function renderGameState(gameData) {
                if (gameData.status === 'abandoned' && gameData.playerIds.includes(currentUser.uid)) {
                    showMessage("Your opponent has left the game.");
                    setTimeout(() => leaveGameBtn.click(), 3000);
                    return;
                }
                chess.load(gameData.fen);
                drawBoard();
                updatePlayerInfo(gameData);
                updateStatus(gameData);
            }

            function drawBoard() {
                boardElement.innerHTML = '';
                const board = chess.board();
                const isWhiteView = playerColor === 'w';

                for (let i = 0; i < 8; i++) {
                    for (let j = 0; j < 8; j++) {
                        const row = isWhiteView ? i : 7 - i;
                        const col = isWhiteView ? j : 7 - j;
                        
                        const squareEl = document.createElement('div');
                        const squareName = String.fromCharCode(97 + col) + (8 - row);
                        squareEl.dataset.square = squareName;
                        squareEl.classList.add('square', (row + col) % 2 === 0 ? 'light' : 'dark');
                        
                        const piece = board[row][col];
                        if (piece) {
                            const pieceEl = document.createElement('span');
                            pieceEl.className = `piece piece-${piece.color}`;
                            pieceEl.textContent = getPieceUnicode(piece);
                            squareEl.appendChild(pieceEl);
                        }
                        
                        squareEl.onclick = () => onSquareClick(squareName);
                        boardElement.appendChild(squareEl);
                    }
                }
                adjustPieceSizes();
            }
            
            function onSquareClick(squareName) {
                if (chess.isGameOver() || chess.turn() !== playerColor) return;

                if (selectedSquare) {
                    const move = { from: selectedSquare, to: squareName, promotion: 'q' };
                    try {
                        const result = chess.move(move);
                        if (result) {
                            updateFirebaseWithMove();
                        }
                    } catch (e) { /* Invalid move */ } 
                    finally {
                        clearHighlights();
                        selectedSquare = null;
                    }
                } else {
                    const piece = chess.get(squareName);
                    if (piece && piece.color === playerColor) {
                        selectedSquare = squareName;
                        highlightValidMoves(squareName);
                    }
                }
            }
            
            async function updateFirebaseWithMove() {
                const gameRef = db.collection("mp-chess-games").doc(currentGameId);
                let status = 'active';
                let winner = null;
                if (chess.isGameOver()) {
                    status = 'finished';
                    if (chess.isCheckmate()) {
                        winner = chess.turn() === 'w' ? 'Black' : 'White';
                    } else {
                        winner = 'Draw';
                    }
                }
                await gameRef.update({ fen: chess.fen(), status, winner });
            }

            function highlightValidMoves(square) {
                clearHighlights();
                document.querySelector(`[data-square="${square}"]`).classList.add('selected');
                const moves = chess.moves({ square: square, verbose: true });
                moves.forEach(move => {
                    document.querySelector(`[data-square="${move.to}"]`).classList.add('valid-move');
                });
            }

            function clearHighlights() {
                document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                document.querySelectorAll('.valid-move').forEach(el => el.classList.remove('valid-move'));
                document.querySelectorAll('.in-check').forEach(el => el.classList.remove('in-check'));
            }

            function updatePlayerInfo(gameData) {
                const whitePlayer = Object.values(gameData.players).find(p => p.color === 'w');
                const blackPlayer = Object.values(gameData.players).find(p => p.color === 'b');
                playerWhiteName.textContent = whitePlayer ? whitePlayer.name.split(' ')[0] : 'Waiting...';
                playerBlackName.textContent = blackPlayer ? blackPlayer.name.split(' ')[0] : 'Waiting...';
            }
            
            function updateStatus(gameData) {
                playerWhiteBox.classList.remove('ring-2', 'ring-yellow-400');
                playerBlackBox.classList.remove('ring-2', 'ring-yellow-400');
                clearHighlights();

                if (gameData.status === 'finished') {
                    statusElement.textContent = gameData.winner === 'Draw' ? "Draw!" : `${gameData.winner} wins!`;
                } else if (gameData.status === 'waiting') {
                    statusElement.textContent = 'Waiting for opponent...';
                } else {
                    const turnColor = chess.turn() === 'w' ? 'White' : 'Black';
                    statusElement.textContent = `${turnColor}'s turn`;
                    if (chess.inCheck()) {
                        statusElement.textContent += ' (Check!)';
                        const kingPos = findKing(chess.turn());
                        if(kingPos) document.querySelector(`[data-square="${kingPos}"]`).classList.add('in-check');
                    }
                    if (turnColor === 'White') playerWhiteBox.classList.add('ring-2', 'ring-yellow-400');
                    else playerBlackBox.classList.add('ring-2', 'ring-yellow-400');
                }
            }
            
            function findKing(color) {
                const king = chess.board().flat().find(p => p && p.type === 'k' && p.color === color);
                return king ? king.square : null;
            }

            function getPieceUnicode(piece) {
                const unicodeMap = {
                    w: { p: '♙', r: '♖', n: '♘', b: '♗', q: '♕', k: '♔' },
                    b: { p: '♟', r: '♜', n: '♞', b: '♝', q: '♛', k: '♚' }
                };
                return unicodeMap[piece.color][piece.type];
            }

            // --- UTILS & CHAT ---
            sendChatBtn.onclick = async () => {
                const text = chatInput.value.trim();
                if (text && currentUser) {
                    const chatRef = db.collection("mp-chess-games").doc(currentGameId).collection("messages");
                    await chatRef.add({ text, senderId: currentUser.uid, senderName: currentUser.displayName, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    chatInput.value = '';
                }
            };
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatBtn.click(); });
            
            function showMessage(msg) { messageText.textContent = msg; messageModal.classList.remove('hidden'); }
            closeModalBtn.onclick = () => messageModal.classList.add('hidden');
            gameIdDisplay.onclick = () => navigator.clipboard.writeText(currentGameId).then(() => showMessage("Game ID copied!"));
            
            function adjustPieceSizes() {
                const square = boardElement.querySelector('.square');
                if (square) {
                    const squareWidth = square.offsetWidth;
                    const newSize = squareWidth * 0.75;
                    boardElement.style.setProperty('--piece-font-size', `${newSize}px`);
                }
            }
            window.addEventListener('resize', adjustPieceSizes);
        });
    </script>
</body>
</html>
