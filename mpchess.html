<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Chess</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #F9FAFB; }
        h1 { font-family: 'Fredoka One', cursive; }
        .font-black-ops { font-family: 'Inter', sans-serif; font-weight: 900; }
        .btn-primary {
            @apply px-6 py-3 font-semibold text-white bg-sky-500 rounded-lg shadow-md hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75 transition-all duration-300 transform hover:scale-105;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Chess Game Specific Styles */
        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            aspect-ratio: 1 / 1;
            border: 4px solid #4b5563; /* bg-gray-600 */
        }
        .chess-square {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(20px, 8vmin, 50px);
        }
        .light-square { background-color: #f3f4f6; } /* gray-100 */
        .dark-square { background-color: #374151; } /* gray-700 */
        .chess-piece { cursor: grab; }
        .selected-piece { background-color: rgba(250, 204, 21, 0.5) !important; } /* yellow-400 with opacity */
        .valid-move::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 35%;
            height: 35%;
            background-color: rgba(34, 197, 94, 0.5); /* green-500 with opacity */
            border-radius: 50%;
        }
        /* The color of the pieces themselves */
        .piece-w { color: #e5e7eb; } /* gray-200 */
        .piece-b { color: #111827; } /* gray-900 */
        .turn-indicator { border: 2px solid #facc15; } /* yellow-400 */

        /* Chat Box Styles */
        #chat-messages { height: 150px; }
        #chat-messages div:nth-child(odd) { background-color: #374151; } /* bg-gray-700 */
    </style>
</head>
<body class="bg-gray-900 text-gray-50 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-700">
        <nav class="w-full max-w-7xl mx-auto px-4 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="index.html" class="text-3xl font-black-ops text-white">FALCONIX<span class="text-sky-400">GAMING</span></a>
                <div id="auth-container" class="flex items-center">
                     <div id="user-info-header" class="hidden items-center space-x-4">
                         <span id="user-display-name" class="text-white font-semibold"></span>
                     </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex items-center justify-center flex-grow w-full px-4">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-4xl my-8 border border-gray-700">
            
            <!-- Loading View -->
            <div id="loading-view" class="text-center">
                <h1 class="text-4xl font-bold text-gray-100 mb-4">Checking Login Status...</h1>
                <p class="text-gray-400">Please wait.</p>
            </div>

            <!-- Auth View -->
            <div id="auth-view" class="text-center hidden">
                <h1 class="text-4xl font-bold text-gray-100 mb-4">Welcome!</h1>
                <p class="text-gray-400 mb-6">Please log in on the main page to play multiplayer chess.</p>
                <a href="index.html?login=true" class="btn-primary w-full inline-block">Go to Login</a>
            </div>

            <!-- Lobby View -->
            <div id="lobby-view" class="hidden">
                <h1 class="text-4xl text-center font-bold text-gray-100 mb-6">Multiplayer Chess</h1>
                <div class="space-y-4">
                    <button id="create-game-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Create New Game</button>
                    <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-gray-600"></div><span class="flex-shrink mx-4 text-gray-400">OR</span><div class="flex-grow border-t border-gray-600"></div></div>
                    <input type="text" id="game-id-input" placeholder="Enter Game ID to Join" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400">
                    <button id="join-game-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Join Game</button>
                </div>
                 <div class="text-center mt-6 text-xs text-gray-500"><p>Your User ID: <span id="user-id-display" class="font-mono"></span></p></div>
            </div>

            <!-- Game View -->
            <div id="game-view" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div id="chess-board" class="chess-board"></div>
                </div>
                <div class="flex flex-col justify-between">
                    <div>
                        <div id="player2-box" class="p-4 rounded-lg mb-4 bg-gray-900">
                            <p class="text-lg font-bold text-gray-400">Black (<span id="player-black-name"></span>)</p>
                        </div>
                        <div id="status" class="text-center text-xl font-semibold text-gray-400 my-4 h-8 flex items-center justify-center"></div>
                        <div id="player1-box" class="p-4 rounded-lg mt-4 bg-gray-900">
                            <p class="text-lg font-bold text-gray-200">White (<span id="player-white-name"></span>)</p>
                        </div>
                    </div>
                    <div id="chat-box" class="mb-4">
                        <div id="chat-messages" class="bg-gray-900 rounded-lg p-2 overflow-y-auto border border-gray-600"></div>
                        <div class="flex mt-2">
                            <input type="text" id="chat-input" placeholder="Type a message..." class="flex-grow p-2 bg-gray-700 border border-gray-600 rounded-l-lg text-white">
                            <button id="send-chat-btn" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-r-lg hover:bg-sky-600">Send</button>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 text-center mb-2">Game ID: <span id="game-id-display" class="font-mono cursor-pointer" title="Click to copy"></span></p>
                        <button id="leave-game-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700">Leave Game</button>
                    </div>
                </div>
            </div>

             <!-- Message Modal -->
            <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center"><p id="message-text" class="text-lg mb-4"></p><button id="close-modal-btn" class="btn-primary">Close</button></div></div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-900 border-t border-gray-700">
        <div class="w-full max-w-7xl mx-auto px-4 lg:px-8 py-8 text-center text-gray-400">
            <p>&copy; 2025 <a href="https://chat.whatsapp.com/DUXdfaOxJoPC87KjRWbkjo" style="text-decoration:underline;">FalconixGaming</a>. All Rights Reserved.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { Chess } from 'https://cdn.skypack.dev/chess.js';

        // FIX: Wrap the entire script in a DOMContentLoaded listener to prevent race conditions.
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyD02ui4dhTuGLz-Ff1af36ERdqqsn4iIeU",
                authDomain: "falconixgaming-46210.firebaseapp.com",
                projectId: "falconixgaming-46210",
                storageBucket: "falconixgaming-46210.appspot.com",
                messagingSenderId: "1096905282147",
                appId: "1:1096905282147:web:e2faa9105d31c6ec009e56",
                measurementId: "G-VJ6YC0GXK5"
            };
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // DOM Elements
            const loadingView = document.getElementById('loading-view'), authView = document.getElementById('auth-view'), lobbyView = document.getElementById('lobby-view'), gameView = document.getElementById('game-view');
            const userInfoHeader = document.getElementById('user-info-header'), userDisplayName = document.getElementById('user-display-name');
            const createGameBtn = document.getElementById('create-game-btn'), joinGameBtn = document.getElementById('join-game-btn'), leaveGameBtn = document.getElementById('leave-game-btn');
            const gameIdInput = document.getElementById('game-id-input'), userIdDisplay = document.getElementById('user-id-display'), gameIdDisplay = document.getElementById('game-id-display');
            const statusDisplay = document.getElementById('status'), chessBoardEl = document.getElementById('chess-board');
            const playerWhiteName = document.getElementById('player-white-name'), playerBlackName = document.getElementById('player-black-name');
            const player1Box = document.getElementById('player1-box'), player2Box = document.getElementById('player2-box');
            const chatMessages = document.getElementById('chat-messages'), chatInput = document.getElementById('chat-input'), sendChatBtn = document.getElementById('send-chat-btn');
            const messageModal = document.getElementById('message-modal'), messageText = document.getElementById('message-text'), closeModalBtn = document.getElementById('close-modal-btn');

            // Game State
            let currentUser = null, currentGameId = null, playerColor = null;
            let unsubscribeGame = null, unsubscribeChat = null;
            let chess = new Chess();
            let selectedPiece = null; // This will store the square name, e.g., 'e2'

            // --- AUTH ---
            onAuthStateChanged(auth, user => {
                currentUser = user;
                loadingView.classList.add('hidden'); 
                if (user) {
                    userDisplayName.textContent = user.displayName;
                    userIdDisplay.textContent = user.uid;
                    userInfoHeader.classList.remove('hidden');
                    authView.classList.add('hidden');
                    if (gameView.classList.contains('hidden')) lobbyView.classList.remove('hidden');
                } else {
                    userDisplayName.textContent = '';
                    userInfoHeader.classList.add('hidden');
                    authView.classList.remove('hidden');
                    lobbyView.classList.add('hidden');
                    if (!gameView.classList.contains('hidden')) leaveGameBtn.click();
                }
            });

            // --- LOBBY ---
            createGameBtn.onclick = async () => {
                const gameId = crypto.randomUUID().split('-')[0];
                const gameRef = doc(db, "mp-chess-games", gameId);
                await setDoc(gameRef, {
                    fen: chess.fen(),
                    pgn: chess.pgn(),
                    players: { [currentUser.uid]: { color: 'w', name: currentUser.displayName } },
                    playerIds: [currentUser.uid],
                    status: 'waiting', // waiting, active, finished, abandoned
                    winner: null
                });
                switchToGameView(gameId, 'w');
            };

            joinGameBtn.onclick = async () => {
                const gameId = gameIdInput.value.trim();
                if (!gameId) return showMessage("Please enter a Game ID.");
                const gameRef = doc(db, "mp-chess-games", gameId);
                const gameSnap = await getDoc(gameRef);

                if (gameSnap.exists()) {
                    const gameData = gameSnap.data();
                    if (gameData.playerIds.length === 1 && !gameData.playerIds.includes(currentUser.uid)) {
                        await updateDoc(gameRef, {
                            [`players.${currentUser.uid}`]: { color: 'b', name: currentUser.displayName },
                            playerIds: [...gameData.playerIds, currentUser.uid],
                            status: 'active'
                        });
                        switchToGameView(gameId, 'b');
                    } else if (gameData.playerIds.includes(currentUser.uid)) {
                        // Rejoin the game
                        switchToGameView(gameId, gameData.players[currentUser.uid].color);
                    } else {
                        showMessage("This game is full.");
                    }
                } else {
                    showMessage("Game not found.");
                }
            };
            
            leaveGameBtn.onclick = async () => {
                if (currentGameId) {
                    // Set status to abandoned so the other player is notified
                    await updateDoc(doc(db, "mp-chess-games", currentGameId), { status: 'abandoned' }).catch(()=>{});
                }
                if (unsubscribeGame) unsubscribeGame();
                if (unsubscribeChat) unsubscribeChat();
                switchToLobbyView();
            };

            // --- GAME VIEW & LOGIC ---
            function switchToGameView(gameId, color) {
                currentGameId = gameId; playerColor = color;
                gameIdDisplay.textContent = gameId;
                lobbyView.classList.add('hidden');
                gameView.classList.remove('hidden');

                unsubscribeGame = onSnapshot(doc(db, "mp-chess-games", gameId), (doc) => {
                    const gameData = doc.data();
                    if (gameData) {
                        renderGameState(gameData);
                    } else {
                        showMessage("Game session has been deleted.");
                        leaveGameBtn.click();
                    }
                });

                const q = query(collection(db, "mp-chess-games", gameId, "messages"), orderBy("timestamp"));
                unsubscribeChat = onSnapshot(q, (snapshot) => {
                    chatMessages.innerHTML = '';
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const sender = msg.senderName ? msg.senderName.split(' ')[0] : 'User';
                        chatMessages.innerHTML += `<div class="p-2 rounded-lg"><strong>${sender}:</strong> ${msg.text}</div>`;
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }

            function switchToLobbyView() {
                gameView.classList.add('hidden');
                if(currentUser) lobbyView.classList.remove('hidden');
                else authView.classList.remove('hidden');
                // Reset game state variables
                currentGameId = null; playerColor = null; selectedPiece = null; chess = new Chess();
            }

            function renderGameState(gameData) {
                if (handleAbandoned(gameData)) return;

                chess.load(gameData.fen);
                drawBoard();
                updatePlayerInfo(gameData);
                updateStatus(gameData);
            }

            function drawBoard() {
                chessBoardEl.innerHTML = '';
                const board = chess.board();
                const isWhiteView = playerColor === 'w';

                // Iterate through the board based on player's perspective
                for (let i = 0; i < 8; i++) {
                    for (let j = 0; j < 8; j++) {
                        const row = isWhiteView ? i : 7 - i;
                        const col = isWhiteView ? j : 7 - j;
                        
                        const squareEl = document.createElement('div');
                        const squareName = String.fromCharCode(97 + col) + (8 - row);
                        squareEl.dataset.square = squareName;
                        squareEl.classList.add('chess-square', (row + col) % 2 === 0 ? 'light-square' : 'dark-square');
                        
                        const piece = board[row][col];
                        if (piece) {
                            squareEl.innerHTML = getPieceUnicode(piece);
                            squareEl.classList.add('chess-piece', `piece-${piece.color}`);
                        }
                        
                        squareEl.onclick = () => onSquareClick(squareName);
                        chessBoardEl.appendChild(squareEl);
                    }
                }
            }
            
            function onSquareClick(squareName) {
                if (chess.isGameOver() || chess.turn() !== playerColor) return;

                if (selectedPiece) {
                    // Attempt to move the selected piece
                    const move = { from: selectedPiece, to: squareName, promotion: 'q' }; // Auto-promote to Queen for simplicity
                    
                    try {
                        const result = chess.move(move);
                        if (result) {
                            updateFirebaseWithMove();
                        }
                    } catch (e) {
                        // This catch block handles invalid moves. We can just ignore them.
                        // The user might have clicked on a non-valid square.
                    } finally {
                        // Always clear selection after a click, whether the move was valid or not
                        clearHighlights();
                        selectedPiece = null;
                    }
                } else {
                    // No piece is selected, so select one if it's the player's piece
                    const piece = chess.get(squareName);
                    if (piece && piece.color === playerColor) {
                        selectedPiece = squareName;
                        highlightValidMoves(squareName);
                    }
                }
            }
            
            async function updateFirebaseWithMove() {
                const gameRef = doc(db, "mp-chess-games", currentGameId);
                let status = 'active';
                let winner = null;
                if (chess.isGameOver()) {
                    status = 'finished';
                    if (chess.isCheckmate()) {
                        winner = chess.turn() === 'w' ? 'Black' : 'White';
                    } else {
                        winner = 'Draw';
                    }
                }
                await updateDoc(gameRef, { fen: chess.fen(), pgn: chess.pgn(), status, winner });
            }

            function highlightValidMoves(square) {
                clearHighlights();
                document.querySelector(`[data-square="${square}"]`).classList.add('selected-piece');
                const moves = chess.moves({ square: square, verbose: true });
                moves.forEach(move => {
                    document.querySelector(`[data-square="${move.to}"]`).classList.add('valid-move');
                });
            }

            function clearHighlights() {
                document.querySelectorAll('.selected-piece').forEach(el => el.classList.remove('selected-piece'));
                document.querySelectorAll('.valid-move').forEach(el => el.classList.remove('valid-move'));
            }

            function updatePlayerInfo(gameData) {
                const whitePlayer = Object.values(gameData.players).find(p => p.color === 'w');
                const blackPlayer = Object.values(gameData.players).find(p => p.color === 'b');
                playerWhiteName.textContent = whitePlayer ? whitePlayer.name.split(' ')[0] : 'Waiting...';
                playerBlackName.textContent = blackPlayer ? blackPlayer.name.split(' ')[0] : 'Waiting...';
            }
            
            function updateStatus(gameData) {
                player1Box.classList.remove('turn-indicator');
                player2Box.classList.remove('turn-indicator');

                if (gameData.status === 'finished') {
                    statusDisplay.textContent = gameData.winner === 'Draw' ? "Draw!" : `${gameData.winner} wins!`;
                } else if (gameData.status === 'waiting') {
                    statusDisplay.textContent = 'Waiting for opponent...';
                } else {
                    const turnColor = chess.turn() === 'w' ? 'White' : 'Black';
                    statusDisplay.textContent = `${turnColor}'s turn`;
                    if (chess.isCheck()) {
                        statusDisplay.textContent += ' (Check!)';
                    }
                    if (turnColor === 'White') player1Box.classList.add('turn-indicator');
                    else player2Box.classList.add('turn-indicator');
                }
            }
            
            function getPieceUnicode(piece) {
                const unicodeMap = {
                    w: { p: '♙', r: '♖', n: '♘', b: '♗', q: '♕', k: '♔' },
                    b: { p: '♟', r: '♜', n: '♞', b: '♝', q: '♛', k: '♚' }
                };
                return unicodeMap[piece.color][piece.type];
            }

            // --- UTILS & CHAT ---
            function handleAbandoned(gameData) {
                if (gameData.status === 'abandoned') {
                    showMessage("Your opponent has left the game.");
                    setTimeout(() => leaveGameBtn.click(), 3000);
                    return true;
                }
                return false;
            }

            sendChatBtn.onclick = async () => {
                const text = chatInput.value.trim();
                if (text && currentUser) {
                    const chatRef = collection(db, "mp-chess-games", currentGameId, "messages");
                    await addDoc(chatRef, { text, senderId: currentUser.uid, senderName: currentUser.displayName, timestamp: serverTimestamp() });
                    chatInput.value = '';
                }
            };
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatBtn.click(); });
            
            function showMessage(msg) { messageText.textContent = msg; messageModal.classList.remove('hidden'); }
            closeModalBtn.onclick = () => messageModal.classList.add('hidden');
            gameIdDisplay.onclick = () => navigator.clipboard.writeText(currentGameId).then(() => showMessage("Game ID copied!"));
        });
    </script>
</body>
</html>
