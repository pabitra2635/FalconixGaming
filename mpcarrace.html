<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Multiplayer Car Racer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #F9FAFB; overflow: hidden; }
        h1 { font-family: 'Fredoka One', cursive; }
        .font-black-ops { font-family: 'Inter', sans-serif; font-weight: 900; }
        .btn-primary {
            @apply px-6 py-3 font-semibold text-white bg-sky-500 rounded-lg shadow-md hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75 transition-all duration-300 transform hover:scale-105;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #game-canvas { display: block; background-color: #374151; } /* bg-gray-700 */
        .crashed { text-decoration: line-through; color: #ef4444 !important; /* red-500 */ }

        /* Chat Box Styles */
        #chat-messages { height: 100px; }
        #chat-messages div:nth-child(odd) { background-color: #374151; } /* bg-gray-700 */
    </style>
</head>
<body class="bg-gray-900 text-gray-50 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-700">
        <nav class="w-full max-w-7xl mx-auto px-4 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="index.html" class="text-3xl font-black-ops text-white">FALCONIX<span class="text-sky-400">GAMING</span></a>
                <div id="auth-container" class="flex items-center">
                    <div id="user-info-header" class="hidden items-center space-x-4">
                        <span id="user-display-name" class="text-white font-semibold"></span>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex items-center justify-center flex-grow w-full px-4">
        <div id="main-container" class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl w-full max-w-md my-8 border border-gray-700">

            <!-- Loading View -->
            <div id="loading-view" class="text-center">
                <h1 class="text-4xl font-bold text-gray-100 mb-4">Checking Login Status...</h1>
                <p class="text-gray-400">Please wait.</p>
            </div>

            <!-- Auth View -->
            <div id="auth-view" class="text-center hidden">
                <h1 class="text-4xl font-bold text-gray-100 mb-4">Welcome Racer!</h1>
                <p class="text-gray-400 mb-6">Please log in on the main page to play multiplayer.</p>
                <a href="index.html?login=true" class="btn-primary w-full inline-block">Go to Login</a>
            </div>

            <!-- Lobby View -->
            <div id="lobby-view" class="hidden">
                <h1 class="text-4xl text-center font-bold text-gray-100 mb-6">Multiplayer Racer</h1>
                <div class="space-y-4">
                    <button id="create-game-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Create New Game</button>
                    <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-gray-600"></div><span class="flex-shrink mx-4 text-gray-400">OR</span><div class="flex-grow border-t border-gray-600"></div></div>
                    <input type="text" id="game-id-input" placeholder="Enter Game ID to Join" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-400">
                    <button id="join-game-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Join Game</button>
                </div>
                <div class="text-center mt-6 text-xs text-gray-500"><p>Your User ID: <span id="user-id-display" class="font-mono"></span></p></div>
            </div>

            <!-- Game View -->
            <div id="game-view" class="hidden w-full">
                 <!-- Game ID and Share Button -->
                <div class="text-center mb-4 flex justify-center items-center gap-4">
                    <p class="text-sm text-gray-400">Game ID: <span id="game-id-display" class="font-mono cursor-pointer" title="Click to copy"></span></p>
                    <button id="share-game-btn" class="bg-indigo-500 text-white text-xs font-bold py-1 px-3 rounded-lg hover:bg-indigo-600 transition-all hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                        Share
                    </button>
                </div>
                <!-- Scoreboard -->
                <div id="scoreboard" class="flex justify-around text-center mb-2">
                    <div id="player1-score-box" class="p-2 rounded-lg transition-all duration-300"><p id="player1-name" class="text-lg font-bold text-pink-500">Player 1</p></div>
                    <div id="player2-score-box" class="p-2 rounded-lg transition-all duration-300"><p id="player2-name" class="text-lg font-bold text-sky-500">Player 2</p></div>
                </div>
                 <!-- Status Display -->
                <div id="status" class="text-center text-xl font-semibold text-gray-400 mb-2 h-8 flex items-center justify-center"></div>
                <!-- Game Canvas -->
                <div class="relative w-full aspect-[3/4] mb-4">
                     <canvas id="game-canvas" class="rounded-lg w-full h-full"></canvas>
                </div>
                 <!-- Chat Box -->
                <div id="chat-box" class="mb-4">
                    <div id="chat-messages" class="bg-gray-900 rounded-lg p-2 overflow-y-auto border border-gray-600"></div>
                    <div class="flex mt-2">
                        <input type="text" id="chat-input" placeholder="Type a message..." class="flex-grow p-2 bg-gray-700 border border-gray-600 rounded-l-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-400">
                        <button id="send-chat-btn" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-r-lg hover:bg-sky-600">Send</button>
                    </div>
                </div>
                <div class="space-y-2">
                    <button id="rematch-btn" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 hidden">Request Rematch</button>
                    <button id="leave-game-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700">Leave Game</button>
                </div>
            </div>
             <!-- Message Modal -->
            <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"><div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm"><p id="message-text" class="text-lg mb-4"></p><button id="close-modal-btn" class="btn-primary">Close</button></div></div>
        </div>
    </main>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD02ui4dhTuGLz-Ff1af36ERdqqsn4iIeU",
            authDomain: "falconixgaming-46210.firebaseapp.com",
            projectId: "falconixgaming-46210",
            storageBucket: "falconixgaming-46210.appspot.com",
            messagingSenderId: "1096905282147",
            appId: "1:1096905282147:web:e2faa9105d31c6ec009e56",
            measurementId: "G-VJ6YC0GXK5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM ELEMENTS ---
        const mainContainer = document.getElementById('main-container');
        const loadingView = document.getElementById('loading-view');
        const authView = document.getElementById('auth-view'), lobbyView = document.getElementById('lobby-view'), gameView = document.getElementById('game-view');
        const userInfoHeader = document.getElementById('user-info-header'), userDisplayName = document.getElementById('user-display-name');
        const createGameBtn = document.getElementById('create-game-btn'), joinGameBtn = document.getElementById('join-game-btn');
        const leaveGameBtn = document.getElementById('leave-game-btn'), rematchBtn = document.getElementById('rematch-btn');
        const gameIdInput = document.getElementById('game-id-input'), userIdDisplay = document.getElementById('user-id-display');
        const gameIdDisplay = document.getElementById('game-id-display'), statusDisplay = document.getElementById('status');
        const player1Name = document.getElementById('player1-name'), player2Name = document.getElementById('player2-name');
        const gameCanvas = document.getElementById('game-canvas'), ctx = gameCanvas.getContext('2d');
        const chatMessages = document.getElementById('chat-messages'), chatInput = document.getElementById('chat-input'), sendChatBtn = document.getElementById('send-chat-btn');
        const messageModal = document.getElementById('message-modal'), messageText = document.getElementById('message-text'), closeModalBtn = document.getElementById('close-modal-btn');
        const shareGameBtn = document.getElementById('share-game-btn');
        
        // --- GAME STATE & CONSTANTS ---
        let currentUser = null, currentGameId = null, playerRole = null;
        let unsubscribeGame = null, unsubscribeChat = null;
        let animationFrameId = null;
        let localGameState = {}; // Holds the game state from Firestore
        let roadLines = [];
        const keys = { ArrowLeft: false, ArrowRight: false };

        // --- Handle game ID from URL on page load ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameIdFromUrl = urlParams.get('gameId');
            if (gameIdFromUrl) {
                gameIdInput.value = gameIdFromUrl;
                showMessage(`Ready to join game ${gameIdFromUrl}. Click "Join Game" when you're logged in!`);
            }
        });

        // --- AUTHENTICATION FLOW ---
        onAuthStateChanged(auth, user => {
            currentUser = user;
            loadingView.classList.add('hidden'); 
            if (user) {
                userDisplayName.textContent = user.displayName;
                userIdDisplay.textContent = user.uid;
                userInfoHeader.classList.remove('hidden');
                authView.classList.add('hidden');
                if (gameView.classList.contains('hidden')) { 
                    lobbyView.classList.remove('hidden');
                }
            } else {
                userDisplayName.textContent = '';
                userInfoHeader.classList.add('hidden');
                authView.classList.remove('hidden');
                lobbyView.classList.add('hidden');
                if (!gameView.classList.contains('hidden')) {
                    leaveGameBtn.click();
                }
            }
        });
        
        // --- LOBBY LOGIC ---
        createGameBtn.onclick = async () => {
            const gameId = crypto.randomUUID().split('-')[0];
            const gameRef = doc(db, "mp-car-race", gameId);
            
            await setDoc(gameRef, {
                hostId: currentUser.uid,
                playerIds: [currentUser.uid],
                players: {
                    [currentUser.uid]: { name: currentUser.displayName, x: 150, crashed: false, role: 'P1' }
                },
                obstacles: generateObstacles(),
                status: 'waiting',
                rematch: {}
            });
            switchToGameView(gameId, 'P1');
        };

        joinGameBtn.onclick = async () => {
            const gameId = gameIdInput.value.trim();
            if (!gameId) return showMessage("Please enter a Game ID.");
            const gameRef = doc(db, "mp-car-race", gameId);
            const gameSnap = await getDoc(gameRef);

            if (gameSnap.exists()) {
                const gameData = gameSnap.data();
                if (gameData.playerIds.length === 1 && !gameData.playerIds.includes(currentUser.uid)) {
                    await updateDoc(gameRef, {
                        playerIds: [...gameData.playerIds, currentUser.uid],
                        [`players.${currentUser.uid}`]: { name: currentUser.displayName, x: 250, crashed: false, role: 'P2' },
                        status: 'active'
                    });
                    switchToGameView(gameId, 'P2');
                } else if (gameData.playerIds.includes(currentUser.uid)) {
                    switchToGameView(gameId, gameData.players[currentUser.uid].role);
                } else {
                    showMessage("This game is full.");
                }
            } else {
                showMessage("Game not found.");
            }
        };
        
        leaveGameBtn.onclick = async () => {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (unsubscribeGame) unsubscribeGame();
            if (unsubscribeChat) unsubscribeChat();
            
            if (currentGameId) {
                 const gameRef = doc(db, "mp-car-race", currentGameId);
                 await updateDoc(gameRef, { status: 'abandoned' }).catch(err => {});
            }
            switchToLobbyView();
        };

        rematchBtn.onclick = async () => {
            const gameRef = doc(db, "mp-car-race", currentGameId);
            const gameSnap = await getDoc(gameRef);
            const gameData = gameSnap.data();
            
            const newRematchState = { ...gameData.rematch, [currentUser.uid]: true };
            
            if (Object.keys(newRematchState).length === 2) {
                // Both players want to rematch
                await updateDoc(gameRef, {
                    obstacles: generateObstacles(),
                    players: {
                        [gameData.playerIds[0]]: { ...gameData.players[gameData.playerIds[0]], x: 150, crashed: false },
                        [gameData.playerIds[1]]: { ...gameData.players[gameData.playerIds[1]], x: 250, crashed: false }
                    },
                    status: 'active',
                    rematch: {}
                });
            } else {
                await updateDoc(gameRef, { rematch: newRematchState });
            }
        };

        // --- VIEW SWITCHING ---
        function switchToGameView(gameId, role) {
            currentGameId = gameId; 
            playerRole = role;
            gameIdDisplay.textContent = gameId;
            mainContainer.classList.remove('max-w-md');
            mainContainer.classList.add('max-w-2xl');
            lobbyView.classList.add('hidden');
            gameView.classList.remove('hidden');
            shareGameBtn.classList.remove('hidden');
            
            resizeCanvas();
            initRoadLines();

            const gameRef = doc(db, "mp-car-race", gameId);
            unsubscribeGame = onSnapshot(gameRef, (doc) => {
                const gameData = doc.data();
                if (gameData) {
                    localGameState = gameData;
                    if (!animationFrameId) {
                       gameLoop(); // Start the game loop if it's not already running
                    }
                } else {
                    showMessage("The game session has ended.");
                    leaveGameBtn.click();
                }
            });

             const chatRef = collection(db, "mp-car-race", gameId, "messages");
             const q = query(chatRef, orderBy("timestamp"));
             unsubscribeChat = onSnapshot(q, (snapshot) => {
                 chatMessages.innerHTML = '';
                 snapshot.forEach(doc => {
                     const msg = doc.data();
                     chatMessages.innerHTML += `<div class="p-1 rounded text-sm">${msg.senderName}: ${msg.text}</div>`;
                 });
                 chatMessages.scrollTop = chatMessages.scrollHeight;
             });
        }
        
        function switchToLobbyView() {
            currentGameId = null;
            localGameState = {};
            mainContainer.classList.add('max-w-md');
            mainContainer.classList.remove('max-w-2xl');
            gameView.classList.add('hidden');
            if(currentUser) lobbyView.classList.remove('hidden');
            else authView.classList.remove('hidden');
            gameIdInput.value = '';
            shareGameBtn.classList.add('hidden');
        }

        // --- CANVAS & GAME LOGIC ---
        function resizeCanvas() {
            const container = gameCanvas.parentElement;
            gameCanvas.width = container.clientWidth;
            gameCanvas.height = container.clientHeight;
        }

        function initRoadLines() {
            roadLines = [];
            for (let i = 0; i < 5; i++) {
                roadLines.push({ y: i * (gameCanvas.height / 4) });
            }
        }
        
        function generateObstacles() {
            const obstacles = [];
            const lanes = [0.15, 0.5, 0.85]; // Relative X positions for 3 lanes
            for (let i = 0; i < 50; i++) { // Generate a long track of obstacles
                 obstacles.push({
                    x: lanes[Math.floor(Math.random() * lanes.length)], // position relative to canvas width
                    y: -100 - (i * (200 + Math.random() * 200)), // position above the canvas
                    speed: 3 + Math.random() * 2,
                    color: Math.random() < 0.2 ? '#ef4444' : '#a855f7' // 20% fast red cars
                });
            }
            return obstacles;
        }

        function update() {
            if (!localGameState.players || !currentUser) return;
            
            const myPlayerState = localGameState.players[currentUser.uid];
            if (!myPlayerState || myPlayerState.crashed || localGameState.status !== 'active') return;

            // Move road lines and obstacles
            const roadSpeed = 4;
            roadLines.forEach(line => { line.y += roadSpeed; if (line.y > gameCanvas.height) line.y = -40; });
            localGameState.obstacles.forEach(obs => obs.y += obs.speed);

            // Move local player car
            const carWidth = 40;
            let currentX = myPlayerState.x;
            if (keys.ArrowLeft && currentX > 0) currentX -= 5;
            if (keys.ArrowRight && currentX < gameCanvas.width - carWidth) currentX += 5;
            
            // Check for collision
            const carHeight = 60;
            const myCarY = gameCanvas.height - 100;
            for (const obs of localGameState.obstacles) {
                const obsX = obs.x * gameCanvas.width - carWidth / 2;
                 if (currentX < obsX + carWidth && currentX + carWidth > obsX && myCarY < obs.y + carHeight && myCarY + carHeight > obs.y) {
                    // Collision detected
                    updateDoc(doc(db, "mp-car-race", currentGameId), { [`players.${currentUser.uid}.crashed`]: true });
                    return; // Stop updating after crash
                }
            }

            // Update Firestore if position changed
            if (currentX !== myPlayerState.x) {
                updateDoc(doc(db, "mp-car-race", currentGameId), { [`players.${currentUser.uid}.x`]: currentX });
            }
        }

        function draw() {
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height); // Clear canvas

            // Draw road lines
            ctx.fillStyle = '#6b7280';
            const laneWidth = gameCanvas.width / 3;
            roadLines.forEach(line => {
                ctx.fillRect(laneWidth - 5, line.y, 10, 40);
                ctx.fillRect(laneWidth * 2 - 5, line.y, 10, 40);
            });
            
            if (!localGameState.players) return;

            // Draw obstacles
            localGameState.obstacles.forEach(obs => {
                const carWidth = 40;
                ctx.fillStyle = obs.color;
                ctx.fillRect(obs.x * gameCanvas.width - carWidth / 2, obs.y, carWidth, 60);
            });
            
            // Draw player cars
            for (const uid in localGameState.players) {
                const player = localGameState.players[uid];
                ctx.fillStyle = player.role === 'P1' ? '#ec4899' : '#38bdf8'; // pink or sky blue
                if (player.crashed) ctx.globalAlpha = 0.4;
                ctx.fillRect(player.x, gameCanvas.height - 100, 40, 60);
                ctx.globalAlpha = 1.0;
            }
        }

        function renderUI() {
            if (!localGameState.players || !currentUser) return;
            
            const playerStates = Object.values(localGameState.players);
            const p1 = playerStates.find(p => p.role === 'P1');
            const p2 = playerStates.find(p => p.role === 'P2');
            
            player1Name.textContent = p1 ? p1.name.split(' ')[0] : 'Waiting...';
            player1Name.classList.toggle('crashed', p1?.crashed);
            player2Name.textContent = p2 ? p2.name.split(' ')[0] : 'Waiting...';
            player2Name.classList.toggle('crashed', p2?.crashed);

            rematchBtn.classList.add('hidden');
            if (localGameState.status === 'finished') {
                const winner = playerStates.find(p => !p.crashed);
                statusDisplay.textContent = winner ? `${winner.name} wins!` : "It's a draw!";
                rematchBtn.classList.remove('hidden');
                rematchBtn.disabled = localGameState.rematch[currentUser.uid];
                rematchBtn.textContent = localGameState.rematch[currentUser.uid] ? 'Waiting for opponent...' : 'Request Rematch';
            } else if (localGameState.status === 'waiting') {
                statusDisplay.textContent = 'Waiting for Player 2...';
            } else if (localGameState.status === 'active') {
                statusDisplay.textContent = "Game On!";
            } else if (localGameState.status === 'abandoned') {
                 showMessage("Your opponent left the game.");
                 setTimeout(() => leaveGameBtn.click(), 2000);
            }

            // Check if game is finished
            const activePlayers = playerStates.filter(p => !p.crashed).length;
            if (localGameState.status === 'active' && playerStates.length === 2 && activePlayers <= 1) {
                updateDoc(doc(db, "mp-car-race", currentGameId), { status: 'finished' });
            }
        }

        function gameLoop() {
            update();
            draw();
            renderUI();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // --- EVENT LISTENERS ---
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('keydown', (e) => { if (e.key in keys) keys[e.key] = true; });
        window.addEventListener('keyup', (e) => { if (e.key in keys) keys[e.key] = false; });

        function handleTouch(e) {
            e.preventDefault();
            if (!localGameState.players || !currentUser || localGameState.players[currentUser.uid]?.crashed) return;
            const touchX = e.touches[0].clientX;
            const canvasRect = gameCanvas.getBoundingClientRect();
            const carWidth = 40;
            let targetX = touchX - canvasRect.left - (carWidth / 2);
            if (targetX < 0) targetX = 0;
            if (targetX > gameCanvas.width - carWidth) targetX = gameCanvas.width - carWidth;
            updateDoc(doc(db, "mp-car-race", currentGameId), { [`players.${currentUser.uid}.x`]: targetX });
        }
        gameCanvas.addEventListener('touchstart', handleTouch, { passive: false });
        gameCanvas.addEventListener('touchmove', handleTouch, { passive: false });
        
        sendChatBtn.onclick = async () => {
             const text = chatInput.value.trim();
             if (text && currentUser) {
                 const chatRef = collection(db, "mp-car-race", currentGameId, "messages");
                 await addDoc(chatRef, { text, senderId: currentUser.uid, senderName: currentUser.displayName, timestamp: serverTimestamp() });
                 chatInput.value = '';
             }
        };
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatBtn.click(); });
        
        function showMessage(msg) { messageText.textContent = msg; messageModal.classList.remove('hidden'); }
        closeModalBtn.onclick = () => messageModal.classList.add('hidden');
        gameIdDisplay.onclick = () => navigator.clipboard.writeText(currentGameId).then(() => showMessage("Game ID copied!"));

        shareGameBtn.onclick = async () => {
            if (!currentGameId) return;
            const shareUrl = `${window.location.origin}${window.location.pathname.replace('index.html', 'mpcarrace.html')}?gameId=${currentGameId}`;
            const shareText = `I challenge you to a race on FalconixGaming! ðŸŽï¸ðŸ’¨\n\nJoin my game with this code: ${currentGameId}\n\nOr click the link to join directly:`;
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'FalconixGaming Car Race Challenge',
                        text: shareText,
                        url: shareUrl,
                    });
                } catch (error) {
                    console.error('Error sharing:', error);
                    showMessage('Sharing was cancelled or failed.');
                }
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showMessage('Share feature not supported. Game link copied to clipboard!');
                });
            }
        };

    </script>
</body>
</ht
