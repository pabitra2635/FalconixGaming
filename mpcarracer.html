<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Multiplayer Car Race</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Bangers&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom fonts and styles inspired by the theme */
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
        h1, .btn-primary { font-family: 'Bangers', cursive; letter-spacing: 2px; }

        .btn-primary {
            @apply px-6 py-3 text-xl text-white bg-sky-500 rounded-lg shadow-md hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75 transition-all duration-300 transform hover:scale-105;
        }

        button:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
            transform: scale(1) !important;
        }
        
        /* Style for the mobile GO button to be visually appealing */
        #mobile-go-btn {
            @apply w-full h-32 mt-4 text-5xl font-bold text-white bg-green-500 rounded-2xl shadow-lg
                   border-4 border-green-600
                   flex items-center justify-center
                   active:bg-green-700 active:scale-95 transition-transform duration-150;
            -webkit-tap-highlight-color: transparent; /* Removes tap highlight on mobile */
        }


        /* Game-specific styles */
        #racetrack {
            position: relative;
            height: 200px; /* Height for two lanes and spacing */
            background-color: #4a5568; /* bg-gray-700 */
            border-radius: 10px;
            border: 4px solid #a0aec0; /* bg-gray-400 */
            overflow: hidden;
            background-image: repeating-linear-gradient(
                to right,
                #4a5568,
                #4a5568 40px,
                #cbd5e0 40px,
                #cbd5e0 60px
            );
            animation: move-background 2s linear infinite;
        }

        @keyframes move-background {
            0% { background-position-x: 0; }
            100% { background-position-x: -100px; }
        }

        .car {
            position: absolute;
            width: 60px;
            height: 40px;
            font-size: 40px;
            line-height: 1;
            transition: left 0.2s linear; /* Smooth movement */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #player1-car { top: 30px; }
        #player2-car { top: 130px; }

        #finish-line {
            position: absolute;
            right: 20px;
            top: 0;
            bottom: 0;
            width: 10px;
            background-image: repeating-linear-gradient(white 0px, white 20px, black 20px, black 40px);
        }
        
        /* Chat Box Styles */
        #chat-messages { height: 150px; }
        #chat-messages div:nth-child(odd) { background-color: #374151; } /* bg-gray-700 */

    </style>
</head>
<body class="bg-gray-900 text-gray-50 flex items-center justify-center min-h-screen">

    <!-- Main Content -->
    <main class="w-full max-w-2xl mx-auto p-4">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl w-full border border-gray-700">

            <!-- Loading View -->
            <div id="loading-view" class="text-center">
                <h1 class="text-4xl text-gray-100 mb-4">Warming Up Engines...</h1>
                <p class="text-gray-400">Please wait while we connect you.</p>
            </div>

            <!-- Lobby View -->
            <div id="lobby-view" class="hidden">
                <h1 class="text-5xl text-center text-gray-100 mb-6">Multiplayer Car Race</h1>
                <div class="space-y-4">
                    <button id="create-race-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 text-2xl">Create New Race</button>
                    <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-gray-600"></div><span class="flex-shrink mx-4 text-gray-400">OR</span><div class="flex-grow border-t border-gray-600"></div></div>
                    <input type="text" id="race-id-input" placeholder="Enter Race ID to Join" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-400 text-center">
                    <button id="join-race-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 text-2xl">Join Race</button>
                </div>
                <div class="text-center mt-6 text-xs text-gray-500"><p>Your User ID: <span id="user-id-display" class="font-mono"></span></p></div>
            </div>

            <!-- Game View -->
            <div id="game-view" class="hidden">
                <div class="text-center mb-4 flex justify-center items-center gap-4">
                    <p class="text-sm text-gray-400">Race ID: <span id="race-id-display" class="font-mono cursor-pointer" title="Click to copy"></span></p>
                    <button id="share-race-btn" class="bg-indigo-500 text-white text-xs font-bold py-1 px-3 rounded-lg hover:bg-indigo-600 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                        Share
                    </button>
                </div>

                <!-- Status Display -->
                <div id="status" class="text-center text-2xl font-bold text-yellow-400 mb-4 h-10 flex items-center justify-center"></div>

                <!-- Racetrack -->
                <div id="racetrack" class="mb-4">
                    <div id="finish-line"></div>
                    <div id="player1-car" class="car">üèéÔ∏è</div>
                    <div id="player2-car" class="car">üöì</div>
                </div>
                
                <!-- Player Labels -->
                <div class="flex justify-between text-lg mb-4 px-2">
                    <p id="player1-name" class="text-red-500 font-bold">Player 1</p>
                    <p id="player2-name" class="text-blue-400 font-bold">Player 2</p>
                </div>

                <!-- Instructions -->
                <p id="instructions" class="text-center text-gray-400 mb-4">Mash the <span class="text-white font-bold">[RIGHT ARROW]</span> key or <span class="text-white font-bold">TAP</span> the button to race!</p>
                
                <!-- Mobile Go Button -->
                <button id="mobile-go-btn" class="hidden">GO!</button>

                <!-- Chat Box -->
                <div id="chat-box" class="my-4">
                    <div id="chat-messages" class="bg-gray-900 rounded-lg p-2 overflow-y-auto border border-gray-600"></div>
                    <div class="flex mt-2">
                        <input type="text" id="chat-input" placeholder="Type a message..." class="flex-grow p-2 bg-gray-700 border border-gray-600 rounded-l-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-400">
                        <button id="send-chat-btn" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-r-lg hover:bg-sky-600">Send</button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-2">
                    <button id="play-again-btn" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 hidden text-2xl">Play Again</button>
                    <button id="leave-race-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 text-2xl">Leave Race</button>
                </div>
            </div>
            
            <!-- Message Modal -->
            <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center border border-sky-500">
                    <p id="message-text" class="text-lg mb-4"></p>
                    <button id="close-modal-btn" class="btn-primary">Close</button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, addDoc, serverTimestamp, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD02ui4dhTuGLz-Ff1af36ERdqqsn4iIeU",
            authDomain: "falconixgaming-46210.firebaseapp.com",
            projectId: "falconixgaming-46210",
            storageBucket: "falconixgaming-46210.appspot.com",
            messagingSenderId: "1096905282147",
            appId: "1:1096905282147:web:e2faa9105d31c6ec009e56"
        };
        
        // --- APP INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM ELEMENTS ---
        const loadingView = document.getElementById('loading-view');
        const lobbyView = document.getElementById('lobby-view');
        const gameView = document.getElementById('game-view');
        
        const createRaceBtn = document.getElementById('create-race-btn');
        const joinRaceBtn = document.getElementById('join-race-btn');
        const raceIdInput = document.getElementById('race-id-input');
        const userIdDisplay = document.getElementById('user-id-display');

        const raceIdDisplay = document.getElementById('race-id-display');
        const shareRaceBtn = document.getElementById('share-race-btn');
        const statusDisplay = document.getElementById('status');
        const racetrack = document.getElementById('racetrack');
        const player1Car = document.getElementById('player1-car');
        const player2Car = document.getElementById('player2-car');
        const player1Name = document.getElementById('player1-name');
        const player2Name = document.getElementById('player2-name');
        const mobileGoBtn = document.getElementById('mobile-go-btn');
        
        const playAgainBtn = document.getElementById('play-again-btn');
        const leaveRaceBtn = document.getElementById('leave-race-btn');

        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');

        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // --- GAME STATE ---
        let currentUser = null;
        let currentRaceId = null;
        let playerNumber = null; // 1 or 2
        let unsubscribeGame = null;
        let unsubscribeChat = null;
        const RACE_COLLECTION = 'multiplayer-car-race';

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if (!currentUser.displayName) {
                    currentUser.displayName = `Racer${user.uid.substring(0, 4)}`;
                }
                
                loadingView.classList.add('hidden');
                lobbyView.classList.remove('hidden');
                gameView.classList.add('hidden');
                userIdDisplay.textContent = currentUser.uid;
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (error) {
                        console.error("Custom token sign-in failed, falling back to anonymous", error);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            }
        });


        // --- LOBBY LOGIC ---
        createRaceBtn.onclick = async () => {
            if (!currentUser) return showMessage("You must be logged in to create a race.");
            
            const raceId = crypto.randomUUID().split('-')[0];
            const raceRef = doc(db, RACE_COLLECTION, raceId);
            
            await setDoc(raceRef, {
                players: {
                    [currentUser.uid]: { number: 1, name: currentUser.displayName }
                },
                playerIds: [currentUser.uid],
                positions: { [currentUser.uid]: 0 },
                status: 'waiting', // waiting, countdown, active, finished
                winner: null,
                rematch: {},
                createdAt: serverTimestamp()
            });

            switchToGameView(raceId, 1);
        };

        joinRaceBtn.onclick = async () => {
            if (!currentUser) return showMessage("You must be logged in to join a race.");
            const raceId = raceIdInput.value.trim();
            if (!raceId) return showMessage("Please enter a Race ID.");

            const raceRef = doc(db, RACE_COLLECTION, raceId);
            const raceSnap = await getDoc(raceRef);

            if (raceSnap.exists()) {
                const raceData = raceSnap.data();
                if (raceData.playerIds.includes(currentUser.uid)) {
                    switchToGameView(raceId, raceData.players[currentUser.uid].number);
                } else if (raceData.playerIds.length < 2) {
                    await updateDoc(raceRef, {
                        [`players.${currentUser.uid}`]: { number: 2, name: currentUser.displayName },
                        playerIds: [...raceData.playerIds, currentUser.uid],
                        [`positions.${currentUser.uid}`]: 0,
                        status: 'countdown'
                    });
                    switchToGameView(raceId, 2);
                } else {
                    showMessage("This race is full.");
                }
            } else {
                showMessage("Race not found.");
            }
        };

        // --- VIEW MANAGEMENT ---
        function switchToLobbyView() {
            if (unsubscribeGame) unsubscribeGame();
            if (unsubscribeChat) unsubscribeChat();
            unsubscribeGame = null;
            unsubscribeChat = null;
            currentRaceId = null;
            playerNumber = null;

            gameView.classList.add('hidden');
            lobbyView.classList.remove('hidden');
            raceIdInput.value = '';
            document.removeEventListener('keydown', handleKeyPress);
            mobileGoBtn.removeEventListener('click', handleAdvanceCar);
        }

        function switchToGameView(raceId, pNum) {
            currentRaceId = raceId;
            playerNumber = pNum;
            raceIdDisplay.textContent = raceId;

            lobbyView.classList.add('hidden');
            gameView.classList.remove('hidden');

            const raceRef = doc(db, RACE_COLLECTION, currentRaceId);
            unsubscribeGame = onSnapshot(raceRef, (doc) => {
                if (doc.exists()) {
                    updateUI(doc.data());
                } else {
                    showMessage("The race has ended or was deleted.");
                    switchToLobbyView();
                }
            });

            const chatRef = collection(db, RACE_COLLECTION, currentRaceId, "messages");
            const q = query(chatRef, orderBy("timestamp"));
            unsubscribeChat = onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const msgDiv = document.createElement('div');
                    msgDiv.classList.add('p-2', 'rounded-lg', 'text-sm');
                    const senderName = msg.senderName || `Racer...`;
                    msgDiv.textContent = `${senderName}: ${msg.text}`;
                    chatMessages.appendChild(msgDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });

            document.addEventListener('keydown', handleKeyPress);
            mobileGoBtn.addEventListener('click', handleAdvanceCar);
        }

        // --- GAME UI & LOGIC ---
        function updateUI(raceData) {
            if (!raceData || !currentUser) return;

            const p1_uid = raceData.playerIds[0];
            const p2_uid = raceData.playerIds[1];
            player1Name.textContent = raceData.players[p1_uid]?.name || 'Player 1';
            player2Name.textContent = p2_uid ? (raceData.players[p2_uid]?.name || 'Player 2') : 'Waiting...';

            const trackWidth = racetrack.clientWidth;
            const carWidth = player1Car.clientWidth;
            const maxLeft = trackWidth - carWidth - 10; 

            if (raceData.positions[p1_uid] !== undefined) {
                 player1Car.style.left = `${(raceData.positions[p1_uid] / 100) * maxLeft}px`;
            }
            if (p2_uid && raceData.positions[p2_uid] !== undefined) {
                 player2Car.style.left = `${(raceData.positions[p2_uid] / 100) * maxLeft}px`;
            }

            playAgainBtn.classList.add('hidden');
            playAgainBtn.disabled = false;
            playAgainBtn.textContent = 'Play Again';
            mobileGoBtn.classList.add('hidden');

            switch (raceData.status) {
                case 'waiting':
                    statusDisplay.textContent = 'Waiting for another player...';
                    break;
                case 'countdown':
                    handleCountdown(raceData);
                    break;
                case 'active':
                    statusDisplay.textContent = 'GO! GO! GO!';
                    racetrack.style.animationPlayState = 'running';
                    mobileGoBtn.classList.remove('hidden');
                    break;
                case 'finished':
                    const winnerId = raceData.winner;
                    const winnerName = raceData.players[winnerId]?.name;
                    statusDisplay.textContent = `üéâ ${winnerName} WINS! üéâ`;
                    racetrack.style.animationPlayState = 'paused';
                    playAgainBtn.classList.remove('hidden');
                    if (raceData.rematch[currentUser.uid]) {
                        playAgainBtn.textContent = 'Waiting for opponent...';
                        playAgainBtn.disabled = true;
                    }
                    break;
                case 'abandoned':
                    showMessage("The other player has left the race.");
                    playAgainBtn.classList.remove('hidden');
                    playAgainBtn.textContent = 'Find New Race';
                    playAgainBtn.onclick = () => {
                        leaveRaceBtn.click();
                    };
                    break;
            }
        }
        
        let countdownTimeout;
        function handleCountdown(raceData) {
            clearTimeout(countdownTimeout);
            const raceRef = doc(db, RACE_COLLECTION, currentRaceId);
            
            if (raceData.playerIds[0] === currentUser.uid && raceData.status === 'countdown') {
                statusDisplay.textContent = 'Get Ready... 3';
                countdownTimeout = setTimeout(() => {
                    statusDisplay.textContent = 'Get Set... 2';
                    countdownTimeout = setTimeout(() => {
                        statusDisplay.textContent = 'GO!... 1';
                        countdownTimeout = setTimeout(async () => {
                            // Final check to prevent writing over an abandoned game
                            const finalSnap = await getDoc(raceRef);
                            if (finalSnap.exists() && finalSnap.data().status === 'countdown') {
                                await updateDoc(raceRef, { status: 'active' });
                            }
                        }, 1000);
                    }, 1000);
                }, 1000);
            } else {
                 statusDisplay.textContent = 'Race starting soon...';
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'ArrowRight') {
                handleAdvanceCar();
            }
        }

        async function handleAdvanceCar() {
            const raceRef = doc(db, RACE_COLLECTION, currentRaceId);
            const raceSnap = await getDoc(raceRef);
            if (!raceSnap.exists()) return;

            const raceData = raceSnap.data();
            if (raceData.status !== 'active') return;

            const currentPosition = raceData.positions[currentUser.uid] || 0;
            const newPosition = Math.min(100, currentPosition + 2.5); // Move 2.5% per action

            const updates = {
                [`positions.${currentUser.uid}`]: newPosition
            };

            if (newPosition >= 100 && raceData.winner === null) { // Prevent multiple winner declarations
                updates.status = 'finished';
                updates.winner = currentUser.uid;
            }

            await updateDoc(raceRef, updates);
        }

        // --- ACTION BUTTONS ---
        leaveRaceBtn.onclick = async () => {
            if (currentRaceId && currentUser) {
                const raceRef = doc(db, RACE_COLLECTION, currentRaceId);
                const raceSnap = await getDoc(raceRef);
                if (raceSnap.exists()) {
                    const raceData = raceSnap.data();
                    if (raceData.playerIds.length === 2 && raceData.status !== 'finished' && !raceData.winner) {
                         await updateDoc(raceRef, { status: 'abandoned', winner: raceData.playerIds.find(id => id !== currentUser.uid) });
                    } else {
                         await deleteDoc(raceRef);
                    }
                }
            }
            switchToLobbyView();
        };

        playAgainBtn.onclick = async () => {
            const raceRef = doc(db, RACE_COLLECTION, currentRaceId);
            const raceSnap = await getDoc(raceRef);
            const raceData = raceSnap.data();

            const newRematchState = { ...raceData.rematch, [currentUser.uid]: true };
            
            if (Object.keys(newRematchState).length === 2) {
                await updateDoc(raceRef, {
                    positions: { [raceData.playerIds[0]]: 0, [raceData.playerIds[1]]: 0 },
                    status: 'countdown',
                    winner: null,
                    rematch: {}
                });
            } else {
                await updateDoc(raceRef, { rematch: newRematchState });
            }
        };

        sendChatBtn.onclick = async () => {
            const text = chatInput.value.trim();
            if (text && currentRaceId && currentUser) {
                const chatRef = collection(db, RACE_COLLECTION, currentRaceId, "messages");
                await addDoc(chatRef, {
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName,
                    timestamp: serverTimestamp()
                });
                chatInput.value = '';
            }
        };
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatBtn.click(); });

        // --- UTILITY FUNCTIONS ---
        function showMessage(msg) {
            messageText.textContent = msg;
            messageModal.classList.remove('hidden');
        }
        closeModalBtn.onclick = () => messageModal.classList.add('hidden');
        
        raceIdDisplay.onclick = () => {
            navigator.clipboard.writeText(currentRaceId).then(() => showMessage("Race ID copied to clipboard!"));
        };

        shareRaceBtn.onclick = () => {
            if (!currentRaceId) return;
            const shareUrl = `${window.location.origin}${window.location.pathname}?raceId=${currentRaceId}`;
            const shareText = `Come race me in this awesome car game! üèéÔ∏èüí®\n\nJoin with Race ID: ${currentRaceId}\n\nOr click the link: ${shareUrl}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Car Race Challenge!',
                    text: shareText,
                    url: shareUrl
                }).catch(err => console.log("Share failed", err));
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showMessage('Share feature not available. Race link copied to clipboard!');
                });
            }
        };

    </script>
</body>
</html>
